#!/bin/bash

if [[ -z $1 ]];then
    echo "./owen --help"
    exit
fi

if [[ $1 = "--help" ]];then
    echo -e "
    \033[31m owen started hunting!!!
      .-----------------------------------------------------------------------.
     /          /          /          /          /            /             / |       
    /+=====================================================================+\ |    
    ||          |         |           |          |   __----~~|~~~~~~~~---- || |
    ||          |         |           |   .  .   |~//====....|.          _ || |                
    ||          |         |.          | \_|//    ||||\  ~~~~~|::::... /~   || |            
    ||          |      ___|==_       _|~o~  \/   ||||  \     |    _/~~-    || |           
    ||        __|--~~~.==~||\=_    -_-|~/_-~|-   |\   \      | _/~         || |       
    ||    _-~~  |  .=~    |   \-_    '|~7  /-   /| ||    \   |  /          || |      
    ||  .~      |.~       |    \ -_   |/  /-   / | ||      \ | /           || |  
    || /  ____  |         |      \ ~-_|  /|- _/  |.||       \|/            || | 
    || |~~    ~~|-~~~~--_ |     ~==-/ | | \~--===|~        . |             || | 
    ||          |'        |~-|      /||   |-~\~~ |     __--~~|             || |
    ||          |         |  |-~~-_/ ||   |   ~\_|  _-~      |     /       || | 
    ||          |         |       /  \|    \__   |/~         |      \__    || | 
    ||          |         |   _--~ _/ | .-~~____-|~-/        |         ~~= || |  
    ||          |         |  ((->/~   |.|||' -_| |  ~~-/ ,   |          .  || |  
    ||          |         |           | -_     ~\|     ~~---l|_i__i__i--~~ || |  
    ||          |         |           | _-~-__   |)  \--_____|________--~~ || |  
    ||          |         |           |/.-~~~-~_-|~- |-------|~~~~~~~      || | 
    ||          |         |           |      //.-|~~--\      |             || |
    ||          |         |           |          |           |             || /@
     \+====================================================================+/ 
    \033[0m
    
    \033[33m --path 'github.com/newproject' \033[0m #Enter a directory

            \033[33m --mod \033[0m #Add mod
            \033[33m --git \033[0m #Add repository params '--git repository branch' eg: --git http://github/project/service main
    "
    exit
fi

if [[ -z $GOPATH ]];then
    echo "\033[31m GOPATH NOT INIT  \033[0m"
    exit
fi

echo "Owen will generated cage in $GOPATH/src"

cd $GOPATH/src

path = ""

function back_to_work_dir(){
    cd cage;cp -rf * ../
    cd .. 
    rm -rf ./cage;rm -rf .git
}

function replaceImports(){
    
    sed -i '' "6c\ 
    \"$path/logic\"
    " ./handler/demo_handler.go
    
    sed -i '' "7c\ 
    \"$path/proto\"
    " ./handler/demo_handler.go

    sed -i '' "7c\ 
    \"$path/dao\"
    " ./logic/demo_logic.go
   
    sed -i '' "8c\ 
    \"$path/logic/manage\"
    " ./logic/demo_logic.go

    sed -i '' "8c\ 
    \"$path/utils\"
    " ./logic/backend_logic.go

    sed -i '' "6c\ 
    \"$path/handler\"
    " ./server/server.go
    
    sed -i '' "7c\ 
    \"$path/logic\"
    " ./server/server.go

    sed -i '' "8c\ 
    logicServer \"$path/server\"
    " ./main.go
    
    sed -i '' "9c\ 
    \"$path/utils\"
    " ./main.go
}

function initCage(){
    git clone https://github.com/EAHITechnology/cage.git && back_to_work_dir
     
    rm -rf README.md
    touch README.md

    project_path=$(cd `dirname $0`; pwd)
    project_name="${project_path##*/}"
    
    echo "# $project_name
Automatically generated by Owen
    ">> README.md
}

function initCageFail(){
    echo "\033[31m hunte cage fail  \033[0m"
    exit
}

if [[ $1 = "--path" ]];then
    if [[ -z $2 ]];then
        echo -e "
        \033[31m path nil. Please input path \033[0m
        "
        exit
    fi

    if [[ -e $2 ]];then
        echo -e "
        \033[31m $2 already exists \033[0m
        "
        exit
    fi

    path=$2

    mkdir -p $path;cd $path
    initCage || initCageFail

    replaceImports || echo "replace fail" 
fi

if [[ $3 = "--mod" ]];then
    go mod init
    go mod tidy


    GOVERSION=$(go env GOVERSION)
    version=${GOVERSION#*go}
    big_version=${version%%.*}
    if [[ big_version=1 ]];then
        mid_version=${version#*.}
        mid_version=${mid_version%%.*}
        if [[ mid_version=17  ]];then
            echo "exec go mod tidy -compat=1.17"
            go mod tidy -compat=1.17
        fi
    fi
fi

if [[ $4 = "--git" ]];then
    git init
    
    if [[ -z $5 ]];then
        echo "\033[31m repository null \033[0m"
        exit
    fi
    git remote add origin $5

    if [[ -z $6 ]];then
        echo "\033[31m branch null \033[0m"
        exit
    fi
    git push -u origin $6
fi

echo "hunting over"